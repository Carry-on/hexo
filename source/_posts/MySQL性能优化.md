---
title: MySQL性能优化
date: 2020-07-05 13:00:40
tags: MySQL
---
# MySQL性能优化

## MySQL架构与SQL执行流程

#### MySQL语句执行流程
![MySQL语句执行流程](./MySQL性能优化/MySQL语句执行流程.png)
**注**：mysql8移除了查询缓存功能，这里就没有再画出来了

**1.通信协议**
MySQL是支持多种通信协议的，可以使用同步/异步的方式，支持长连接/短连接
保持长链接会消耗内存，长时间不活动的连接，mysql服务器会自动断开
```sql
show global variables like 'wait_timeout'; --非交互式超时时间，如JDBC程序
show global variables like 'interactive_timeout'; --交互式超时时间，如数据库工具
```
默认是28800秒，8小时

mysql主要有两种通信协议：一种是Unix socket，没有指定-h参数默认采用unix socket（省略了 -S /var/lib/mysql/mysql.sock），一种是TCP/IP，加上-h参数默认是TCP/IP协议

**2.通信方式**
mysql使用的是半双工的通信方式，数据双向传输，但不能同时传输

**3.词法解析和预处理（Parser & Preprocesser）**
一条SQL语句为什么能被识别？
这就是mysql的Parser解析器和Preprocesser预处理模块。
这一步主要做的就是对语句基于sql语法，进行词法和语法的分析，语义的分析。

- 词法分析
词法分析就是把一个完整的sql语句打碎成一个个单词
比如一个简单的sql语句：
`select name from user where id=1; `
它会被打碎成8个符号，每个符号是什么类型，从哪里开始到哪里结束。

- 语法解析
语法解析会对sql做一些语法检查，比如单引号有没有闭合，然后根据mysql的语法规则，生成一个解析树
![MySQL解析树](./MySQL性能优化/MySQL解析树.png)
任何数据库中间件，比如mycat，sharding-JDBC（用到了Druid Parser），都必须有词法和语法分析功能，在市面上也有很多开源的词法解析工具（比如LEX，Yacc）

- 预处理器
问题：如果词法和语法都正确的sql，但是表名和字段不存在，会在哪里报错，是在数据库的执行层还是解析器。比如：
`select * from nothistable;`
解析器可以分析语法，但是它怎么知道数据库里有哪些表，表里有哪些字段？
实际上还是在解析的时候报错的，解析器里又一个预处理器，它会检查生成的解析树，解析解析器无法解决的语义。比如，它会检查表名和列名是否存在，检查名字和别名，保证没有歧义。
预处理之后会得到一个新的解析树。

- 查询优化（Query Optimizer）与查询执行计划
得到解析树后是不是就要执行sql了呢？
一条sql语句是不是只有一种执行方式呢？或者说数据库最终执行的sql是不是就是我们发送给数据库的sql呢？
答案是否定的，一条sql会有很多种执行方式，最终返回相同的结果，他们是等价的。这么多执行方式到底怎么去选择呢？根据什么判断标准去选择呢？
这就是mysql的查询优化器模块（Optimizer）
查询优化器的目标就是：根据解析树生成不同的执行计划（Execution Plan），然后选择一种最优的执行计划，mysql里面有的是基于开销（Cost）的优化器，哪种执行计划开销最小，就用哪个。
下面这个查看查询的开销：
```sql
show status like "Last_query_cost";
```
实际上对于每一种数据库来说，优化器都是必不可少的，他们通过复杂的算法实现尽可能优化查询效率的目标，但是优化器也不是万能的，并不是再垃圾的sql语句都能优化，也不是每次都能选择到最优的执行计划，所以在编写sql语句的时候还是要注意。

优化器是怎么得到执行计划？
首先要启用优化器的跟踪（默认是关闭的）
```sql
show variables like "optimizer_trace";
set optimizer_trace='enable=on';
```
注意：开启这个开关是会消耗性能的，因为它要把优化器分析的结果写到表里面，所以不要轻易开启，或者查看完之后关闭它（设为off）

- 存储引擎
得到执行计划，sql是不是就可以执行了？
问题：1.从逻辑的角度，我们的数据是放在哪里？2.执行计划在哪里执行，由谁去执行？
存放在表table里，表在存储数据的时候，还要组织数据的存储结构，这个存储结构就是我们存储引擎决定的，所以存储引擎也可以叫做表类型。

InnoDB：mysql7之后的默认存储引擎
支持事务，支持外建，数据的完整性，一致性更高
支持行级锁和表级锁。
支持读写并发，写不阻塞读（MVCC）
特殊的索引存储方式（B+ tree），减少IO，提升查询效率

- 执行引擎，返回结果
执行引擎使用执行计划去操作存储引擎，它使用存储引擎提供的API来完成操作，不同存储引擎的API相同，所以修改表的存储引擎，操作方式不需要改变。


#### MySQL的架构与内部模块

#### InnoDB存储引擎的磁盘与内存结构


## MySQL索引原理与使用原则

#### 索引的本质

#### 索引底层的数据结构

#### 不同存储引擎索引的实现方式

#### 索引的创建和使用原则


## MySQL事务与锁

#### 事务的特性与事务的并发造成的问题

#### 事务读一致性问题解决方案

#### MVCC的原理

#### 锁的分类，行锁的原理，行锁的算法


## MySQL性能优化总结

#### MySQL数据库优化的层次和思路

#### MySQL数据库优化工具


